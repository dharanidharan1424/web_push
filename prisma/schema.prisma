// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  websites  Website[]
  plan      Plan      @default(FREE)
}

enum Plan {
  FREE
  PRO
  AGENCY
}

model Website {
  id            String         @id @default(cuid())
  name          String
  url           String
  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subscribers   Subscriber[]
  notifications Notification[]
  segments      Segment[]

  @@index([userId])
}

model Subscriber {
  id                 String              @id @default(cuid())
  endpoint           String              @unique
  p256dh             String
  auth               String
  websiteId          String
  website            Website             @relation(fields: [websiteId], references: [id], onDelete: Cascade)
  userAgent          String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  segments           SubscriberSegment[]
  notificationLogs   NotificationLog[]

  @@index([websiteId])
  @@index([createdAt])
}

model Segment {
  id          String              @id @default(cuid())
  name        String
  description String?
  websiteId   String
  website     Website             @relation(fields: [websiteId], references: [id], onDelete: Cascade)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  subscribers SubscriberSegment[]

  @@index([websiteId])
}

model SubscriberSegment {
  id           String     @id @default(cuid())
  subscriberId String
  subscriber   Subscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  segmentId    String
  segment      Segment    @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([subscriberId, segmentId])
  @@index([subscriberId])
  @@index([segmentId])
}

model Notification {
  id          String            @id @default(cuid())
  title       String
  body        String
  url         String?
  icon        String?
  websiteId   String
  website     Website           @relation(fields: [websiteId], references: [id], onDelete: Cascade)
  segmentIds  String[]          @default([])
  sentCount   Int               @default(0)
  status      String            @default("sent") // 'draft', 'scheduled', 'sent', 'failed'
  scheduledFor DateTime?
  createdAt   DateTime          @default(now())
  logs        NotificationLog[]

  @@index([websiteId])
  @@index([createdAt])
  @@index([status])
}

model NotificationLog {
  id             String       @id @default(cuid())
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  subscriberId   String
  subscriber     Subscriber   @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  status         String       // 'sent', 'failed'
  error          String?
  createdAt      DateTime     @default(now())

  @@index([notificationId])
  @@index([subscriberId])
}
